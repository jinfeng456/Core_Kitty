
using GK.WCS.Common;
using GK.WCS.Common.task;
using GK.WCS.Carrier;
using CMNetLib.Robots.CarrierChain;
using GK.WCS.Common.core.dto;
using System.Threading;
using GK.WCS.DAL;
using GK.WCS.Entity;

namespace GK.WCS.Controller {
    public class CarrierFinishTask:ZtTask {


        ITaskCarrierServer taskCarrierServer = ServerFactray.getServer<ITaskCarrierServer>();
        INoTaskControlServer noTaskControlDAL = ServerFactray.getServer<INoTaskControlServer>();

        public CarrierFinishTask() {
            time = 1000;
        }
        public override void onlyOneTime() {
        
        }
        public override void excute() {
            endCarrier(119);
            endCarrier(121);
            endCarrier(123);
            endCarrier(125);
            endCarrier(127);
            endCarrier(129);

            endCarrier(214);
            endCarrier(216);
            endCarrier(218);
            endCarrier(220);
            endCarrier(222);
            endCarrier(224);
        }


        void endCarrier(int carrier) {
           int index =  carrier * 10 + 1;
            finish(index);
            finish(++index);
        }

      
        void finish(int postion) {
            int end = postion /10;
            HySignalState ss1 = CarrierPool.getSs(postion);
            if(ss1 == null) {
                LoggerCommon.consol(postion+"传输线信号等待中");
                return;
            }
            if( ss1.TaskNo <= 0) {
                return;
            }
            TaskCarrier carrier = taskCarrierServer.getCarrarTasksByTaskNo(ss1.TaskNo);
            if(carrier != null&& carrier.endPath == end&& carrier.status!=3) {
                taskCarrierServer.finshTaskCarrier(carrier.id);
            }

            clearPath(postion);
        }
        void clearPath(int postion) {

            int path = postion / 10;
            HySignalState ss1 = CarrierPool.getSs(postion);
            if(ss1 == null) {
                LoggerCommon.consol(postion + "传输线信号等待中");
                return;
            }
            if(ss1.TaskNo <= 0) {
                return;
            }
            if(ss1.OnOff) {
                return;
            }
               ITaskCraneServer craneTaskDAL = ServerFactray.getServer<ITaskCraneServer>();
        TaskCrane tc = craneTaskDAL.GetItem(ss1.TaskNo);
            if(tc == null || tc.status == 7 || tc.status == 9) {
                int index = postion / 1000;
                if(index == 2) {
                    index = 21;
                }
                CarrierWriteConnect carrierWriteConnect= TaskPool.get<CarrierWriteConnect>(index);
                carrierWriteConnect.clearAction((ushort)(postion % 1000),ss1.TaskNo);
                Thread.Sleep(100);
            }
        }
        

    }
}
