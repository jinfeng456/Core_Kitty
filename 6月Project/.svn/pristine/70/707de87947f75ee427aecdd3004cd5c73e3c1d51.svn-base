<template>
  <div class="page-container">
	<!--新增编辑界面-->
	<el-dialog :title="operation?'销售出库-新增':'销售出库-编辑'" width="80%" :visible.sync="dialogVisible" :close-on-click-modal="false" @opened="getDetials"  :before-close="handleClose">
		<el-form :model="subDataForm" label-width="200px" :rules="dataFormRules" ref="dataForm" :size="size"
			label-position="right">
			<el-row>
				<el-col :span="12">
					<el-form-item label="ID" prop="id" v-if="false">
						<el-input v-model="subDataForm.id" disabled="true" auto-complete="off"></el-input>
					</el-form-item>
				
					<el-form-item :label="$t('field.receipt.srcSoNo')" prop="srcSoNo">
						<el-input v-model="subDataForm.srcSoNo" auto-complete="off"></el-input>
					</el-form-item>
				</el-col>
				<el-col :span="12">
					<el-form-item :label="$t('field.receipt.outType')" prop="outType" >
						<el-select v-model="subDataForm.outType"  style="width: 100%;" disabled="false">
							<el-option v-for="item in dicts.outTypeItem" :key="item.value"
								:label="item.label" :value="item.value">
							</el-option>
						</el-select>
					</el-form-item>
				</el-col>
			</el-row>
			<el-row>
				<el-col :span="12">
					<el-form-item :label="$t('field.receipt.stn')"  prop="stn" >
						<el-select v-model="subDataForm.stn"  :placeholder="$t('action.select')" style="width: 100%;">
							<el-option v-for="item in dicts.stnOut" :key="item.value"  :value="item.value"
								:label="item.label">
							</el-option>
						</el-select>
					</el-form-item>
				
				</el-col>
				<el-col :span="12">
					<el-form-item :label="$t('field.receipt.receiptNo')" prop="receiptNo">
						<el-input v-model="subDataForm.receiptNo" auto-complete="off"></el-input>
					</el-form-item>
				</el-col>
			</el-row>
			<el-row>
				<el-col :span="12">
					<el-form-item :label="$t('field.receipt.priority')" prop="priority">
						<el-select v-model="subDataForm.priority"  :placeholder="$t('action.select')" style="width: 100%;">
							<el-option v-for="item in dicts.priority" :key="item.value"
								:label="item.label" :value="item.value">
							</el-option>
						</el-select>
					</el-form-item>
				</el-col>
			</el-row>
		</el-form>
		<div slot="footer" class="dialog-footer">
			
			<el-button :size="size" @click.native="handleHiddenOut">{{$t('action.cancel')}}</el-button>				
			<el-button :size="size" type="primary" @click.native="submitForm" :loading="editLoading">{{$t('action.submit')}}</el-button>
			<el-button :size="size" icon="el-icon-edit"  @click.native="handleAddDetailEdit"  >选择订单 </el-button>
			<el-button icon="el-icon-edit" :size="size"  @click.native="handleShowSoNo" >查看订单 </el-button>
		</div>

		<div v-show="!operation">
			<div class="app-container">
				<el-table v-loading="listLoading" :data="list" border fit highlight-current-row style="width: 100%" size="mini">
				<el-table-column width="120px" align="center" :label="$t('field.stn')"   fixed="right" prop="stn" key="stn"  header-align="center" :formatter="statusFilter">
				</el-table-column>
				<el-table-column class-name="status-col"  :label="$t('field.itemName')"    min-width="110" prop="itemId"  align="center" fixed="right"  header-align="center"  :formatter="itemFilter">
					
				</el-table-column>
				<el-table-column width="200px"   :label="$t('field.planCount')"    align="center"  fixed="right"  header-align="center" >
				
					<template slot-scope="{row}"  >
						<template v-if="row.edit">
							<el-input v-model="row.planCount" class="edit-input" size="mini"  />
						</template>
						<span  style="cursor: pointer;" v-else  >{{ row.planCount }}</span>
					</template>
				
				</el-table-column>		
				<el-table-column align="center" :label="$t('action.edit')" width="115" fixed="right" >
						<template slot-scope="{row}">
						<!-- <el-button  type="primary" size="small" icon="el-icon-edit" @click="row.edit=!row.edit" >   {{$t('action.edit')}} 
						</el-button> -->
						<el-button v-if="row.edit" type="success" size="mini"  @click="confirmEdit(row)" icon="el-icon-circle-check-outline" > {{$t('action.comfirm')}} 
						</el-button>
						<el-button v-else type="primary" size="mini" icon="el-icon-edit" @click="row.edit=!row.edit" >   {{$t('action.edit')}} 
						</el-button>
						</template>
				</el-table-column>


				<el-table-column :label="$t('action.operation')" width="105" fixed="right"  header-align="center" align="center">	
					<template slot-scope="scope">
	 
					<kt-button icon="fa fa-trash" :label="$t('action.delete')" perms="sys:user:delete" :size="size" type="danger" @click="handleDelete(scope.$index, scope.row)" />
					</template>
				</el-table-column>
				
				</el-table>
			</div>
		</div>
	</el-dialog>
	  <selorder-select :key="componentKey"  :itemDialogVisible="itemDialogVisible" @handleSelect="handleSelect"    @itemHidden="itemHidden"  :items="this.soidList" :showOrder="this.showOrder"></selorder-select>
  </div>
</template>

<script>
import KtTableList from "@/views/Core/KtTableList"
import KtButton from "@/views/Core/KtButton"
import { format } from "@/utils/datetime"
import SelorderSelect from "./SelorderSelect"
export default {
	name: 'EditReceiptOut',
	components:{
		KtTableList,
		KtButton,
		SelorderSelect
	},
	filters: {
	
  },
	props:{
		subDataForm:{
			type: Object
		},
	    dialogVisible:{
			type: Boolean
		},
		operation:{
			type: Boolean
		}
	},
	
	data() {
		return {
			size: 'mini',
			   listLoading: false,
			list:[],
			Items: [],
			showOrder:false,
			pageResult: {},
		    componentKey: 0,
			editLoading: false,
			pageRequest: { pageNum: 1, pageSize: 1000 },
			itemDialogVisible:false,
			itemDialogVisibleAll:false,
			dicts:this.$store.state.dict.dicts,
			soidList:''
		}
	},
	computed: {
		dataFormRules() {
			
			}		
	},
	methods: {
			
				confirmEdit(row) {
						//row.edit = false
						this.$api.receipt.updateDetials({id:row.id,planCount:row.planCount}).then((res) => {
						this.getDetials();
					})
				},

			statusFilter(status) {

			let key="stnOut"
			let dict = this.$store.state.dict.dicts[key];
			if(dict==undefined){
					return status
			}
			for(let i=0;i<dict.length;i++){
				if(dict[i].value==status.stn){
					return dict[i].label;
				}
			}

          	return status
		},
		itemFilter:  function (row, column, cellValue, index){
				let key = ""
				let propt = column.property;
				let val = row[column.property];				
				let dict = this.Items;
				for (let i = 0; i < dict.length; i++) {
					if (dict[i].id == val) {
					return dict[i].name;
					}
				}
				return row[column.property]
      	},
		//加载物料
		findItems: function () {
			this.$api.item.findAll().then((res) => {
				this.Items = res.data			
			})
		},
		handleDelete:function(index,row){
			this.$confirm('确认删除选中记录吗？', '提示', {
				type: 'warning'
			}).then(() => {
					this.$api.receipt.deleteDetial(row.id).then((res) => {
					this.getDetials();
				})
			}).catch(() => {
			})
		},
		handleSelect:function(data){
			//debugger
		 	this.$api.receipt.saveDetialByOrder({id:this.subDataForm.id,items:data}).then((res) => {			
				if(res.code == 200) {
								
							} else {
								this.$message({message: this.$t('action.operateFail') + res.msg, type: 'error'})						
							}
				this.itemHidden();
				this.getDetials();
			})
		},
		handleClose:function(done){
		  this.$emit('receiptHidden', {})
 			done();
		},
		itemHidden:function(){
			this.itemDialogVisible=false;
			this.itemDialogVisibleAll = false;
		},
		// 获取分页数据
		 getDetials :function() {
			if(this.subDataForm==undefined||this.subDataForm.id==undefined||this.subDataForm.id==0){
				return;
			}
			this.listLoading = true

			this.$api.receipt.getDetials(this.subDataForm).then((res) => {
          
 			const items = res.data
			this.list = items.map(v => {
				this.$set(v, 'edit', false) 
				return v
			})			
			this.listLoading = false
			})
		},
		
		
		
		
		handleAddDetailEdit: function () {		
			this.componentKey += 1; 
			this.showOrder=false
			this.soidList="ALL"
			this.itemDialogVisible = true						
		},
		handleShowSoNo: function () {			    
				this.componentKey += 1; 
				this.showOrder=true
				this.$api.whSoOut.GetSoOutReceptList(this.subDataForm).then((res) => {		
				let str='';
				for(var i=0; i<res.data.length; i++) {
					  str+=res.data[i].soid+','
					}
				this.soidList=str	
				this.itemDialogVisible = true		
				console.log(this.soidList)
			})					
		},
		handleHiddenOut: function (params) {
			this.$emit('receiptHidden', {})
		},
		// 编辑
		submitForm: function () {
			this.$refs.dataForm.validate((valid) => {
				if (valid) {
					this.$confirm(this.$t('action.isConfirm'), this.$t('action.tips'), {}).then(() => {
							this.editLoading = true
						let params = Object.assign({}, this.subDataForm)
						
						this.$api.receipt.saveReceiptOut(params).then((res) => {
							this.editLoading = false
							if(res.code == 200) {
								this.$message({ message: this.$t('action.operateSucess'), type: 'success' })
								this.handleHiddenOut();
								this.$refs['dataForm'].resetFields()
							} else {
								this.$message({message: this.$t('action.operateFail') + res.msg, type: 'error'})
							}
						
						})				
						
					})
				}
			})
		}
		
		
		
	},	
	mounted() {
		this.findItems()
	

	}
}
</script>

<style scoped>

</style>