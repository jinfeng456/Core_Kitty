using System;
using System.Collections.Generic;
using GK.WCS.Carrier.dto;
using GK.WCS.Common;
using GK.WCS.Common.core.dto;
using GK.WCS.DAL;
using GK.WCS.Entity;

namespace GK.WCS.Carrier {
    public abstract class CarrierSynchro : ZtTask {
        protected CarrierConnect connect;
        protected int plcId;
        Dictionary<int, CarrierSignalStatus> _hisCarrierMessage;
        Dictionary<int, CarrierSignalStatus> curCarrierMessage;
        List<int> hisTask;
        List<int> curTask;
        ITaskCarrierServer taskCarrierServer = ServerFactray.getServer<ITaskCarrierServer>();
        ITaskCraneServer taskCraneServer = ServerFactray.getServer<ITaskCraneServer>();
        CarrierMachineState MachineState=new CarrierMachineState();
        long lastTime = 0;
        public CarrierSynchro() {
            time = 300;
        }
        public  CarrierSignalStatus getSignalStatut(int id) {
            long des = DateTime.Now.Ticks - lastTime;
            if (des > 10000 * 1000) {
                LoggerCommon.fileAll("传输线信号超时" + des);
                return null;
            }
            return curCarrierMessage[id];
        }
        public Dictionary<int, CarrierSignalStatus> getAllPointSignal()
        {
            long des = DateTime.Now.Ticks - lastTime;
            if (des > 10000 * 1000)
            {
                LoggerCommon.fileAll("传输线信号超时" + des);
                return null;
            }
            return curCarrierMessage;
        }
        abstract public int signCount();

        public override void excute() {
            Dictionary<int, CarrierSignalStatus> curCarrierMessagetemp = readerSign();
            syncSign(curCarrierMessagetemp);//执行中的任务更新数据库状态
            curCarrierMessage = curCarrierMessagetemp;
            _hisCarrierMessage = curCarrierMessagetemp;
            lastTime = DateTime.Now.Ticks;

        }

        Dictionary<int, CarrierSignalStatus> readerSign() {
            byte[] rsTaskNo = connect.getData(52, 0, 104);
            byte[] rsSign = connect.getData(54, 0, 52);
            if (rsTaskNo == null || rsSign == null) {
                return null;
            }
            Dictionary<int, CarrierSignalStatus> carrierMessage = CarrierStatusDB(rsTaskNo, rsSign);
            keyPointAssign(carrierMessage);
            return carrierMessage;
        }
        List<int>  getTasks(Dictionary<int, CarrierSignalStatus> curCarrierMessage) {
               List<int> curTaskTmp=new List<int>();
                 foreach (KeyValuePair<int, CarrierSignalStatus> kvp in curCarrierMessage)//键值对一起遍历
                    {
                       int taskNo=kvp.Value.taskNo;
                        if (taskNo != 0)
                        {
                            if (!curTaskTmp.Contains(taskNo))
                            {
                                curTaskTmp.Add(taskNo);
                            }
                        }
               
                    }
                 return curTaskTmp;
            }


        void syncSign(Dictionary<int, CarrierSignalStatus> curCarrierMessage)
        {
            curTask  = getTasks( curCarrierMessage);
            foreach(int curTk in curTask)
            {
                if (hisTask.Count == 0||!hisTask.Contains(curTk))
                {
                    TaskCarrier taskCarrier = taskCarrierServer.getCarrarTasksByTaskNo(curTk);
                    if (taskCarrier != null)
                    {
                        if (taskCarrier.status == 1)
                        {
                            taskCarrierServer.UpdateTaskCarrierStatus(curTk, 2);
                        }
                    }
                    else
                    {
                        LoggerCommon.fileAll("任务号为 " + curTk + " 的任务不存在！ ");
                    }
                }
            }
            hisTask=curTask;
            finshTask(curCarrierMessage);
        }
        public Dictionary<int, CarrierSignalStatus> CarrierStatusDB(byte[] rsTaskNo, byte[] rsSign)
        {
            int number = rsSign.Length / 2;
            if (rsTaskNo.Length / 4 != number)
            {
                throw new Exception("长度异常");
            }
            Dictionary<int, CarrierSignalStatus> carrierMessage = new Dictionary<int, CarrierSignalStatus>();
            int nameBegin = 1000;
            for (int i = 1; i < number; i++)
            {
                nameBegin += 1;
                int sign = Tools.ushort16(rsSign, (i - 1) * 2);
                int taskNo = Tools.int32(rsTaskNo, (i - 1) * 4);
                CarrierSignalStatus cs = new CarrierSignalStatus(nameBegin, taskNo, sign);
                carrierMessage.Add(nameBegin, cs);
            }
            return carrierMessage;

        }
        public void keyPointAssign(Dictionary<int, CarrierSignalStatus> carrierMessage)
        {
            List <PlcPoint> keyPoint=getKeyPoint();
            byte[] carrierState=connect.getCarrierStatus();
            foreach (var it in keyPoint)
            {
                    CarrierMachineState ms= syncMachineState(carrierState,it.statusOffset);  
                    carrierMessage[it.pathNo].arriveApply=ms.arriveApply;
                    carrierMessage[it.pathNo].arrived = ms.arrived;
                    carrierMessage[it.pathNo].free = ms.free;
                    carrierMessage[it.pathNo].code=ms.CodeMess;
                    carrierMessage[it.pathNo].weight=ms.weight;
                    carrierMessage[it.pathNo].inWHType=ms.inWHType;
                    carrierMessage[it.pathNo].inTask=ms.inTask;
                    carrierMessage[it.pathNo].plcMode=ms.plcMode;
                    carrierMessage[it.pathNo].plcState=ms.plcState;
            }
        }
        public CarrierMachineState syncMachineState(byte[] b,int begin)
        {
           
            MachineState.parseStatus(b,begin);
            return MachineState;
        }
        public void finshTask(Dictionary<int, CarrierSignalStatus> curCarrierMessage)
        {
            List <PlcPoint>  keypoint = getKeyPoint();

            foreach (PlcPoint it in keypoint)
            {
                
                    CarrierSignalStatus carrierSignal = curCarrierMessage[it.pathNo];

                    if (carrierSignal.arrived == 1)
                    {
                       int  taskNO = carrierSignal.taskNo;
                        TaskCarrier taskCarrier = taskCarrierServer.getCarrarTasksByTaskNo(taskNO);
                        if (taskCarrier != null&& taskCarrier.endPath== it.pathNo)

                        {
                            if (taskCarrier.itemType == 2)
                            {
                                taskCarrierServer.UpdateTaskCarrierStatus(taskCarrier.taskNo, 9);
                                connect.clearCarrierTask(it.statusOffset);
                            }
                           else if(taskCarrier.itemType == 1)
                            {
                                taskCarrierServer.UpdateTaskCarrierStatus(taskCarrier.taskNo, 9);
                                TaskCrane taskCrane= taskCraneServer.getTaskCraneByTaskNo(taskCarrier.taskNo);
                                if (taskCrane.status != 1)
                                {
                                    connect.clearCarrierTask(it.statusOffset);
                                }
                            }
                        }
                        else
                        {
                            LoggerCommon.fileAll("托盘号为 " + taskNO + "的入库任务不存在！ ");
                        }
                    }

                
               
            }
        }
        public abstract ushort getDataLength();
        //key path .value plc offset
         
        public abstract List<PlcPoint> getKeyPoint();

        public abstract List<int> getDb51PointList();




    }

    public class PlcPoint{

        public int  pathNo;
        public int  statusOffset;

       public PlcPoint(int pathNo,int statusOffset)
        {
           
            this.pathNo = pathNo;
            this.statusOffset = statusOffset;
    
           
        }


        }
}
