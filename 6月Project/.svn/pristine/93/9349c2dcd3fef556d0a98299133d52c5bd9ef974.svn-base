using System;

using CMNetLib.Robots.Crane;

using System.Threading;
using GK.WCS.Common.task;
using GK.WCS.Entity;
using GK.WCS.DAL;
using GK.WCS.Common.Util;

namespace GK.WCS.Crane
{
    public class CraneTools 
    {
        /// <summary>
        /// 开启前检测堆垛机上次未执行完成的任务
        /// </summary>
        /// <param name="CraneId"></param>
        public static bool DoUnfinishedTask(int CraneId) {
            ITaskCraneServer taskCraneServer = ServerFactray.getServer<ITaskCraneServer>();
           



            CraneConnect connect = TaskPool.get<CraneConnect>(CraneId);
            RobotStatus state = CranePool.instance.get(CraneId);
            foreach(TaskStatusModel tsm in state.TaskState) {
                if(tsm.TaskNo <= 0) {
                    continue;
                }
                TaskCrane item = taskCraneServer.GetItem(tsm.TaskNo);
                if(item == null   || item.status == (int)TaskStatus.SEMIAUTO_COMPLETE) {
                    connect.ClearTaskState(tsm.ForkNo);
                } else {
                    CraneAllocateJobHX job = TaskPool.get<CraneAllocateJobHX>(CraneId);
                    TaskModel st = CraneTools.ConvertTaskModel(item,tsm.ForkNo);
                    connect.SendTask(st);
                    Thread.Sleep(2000);
                  
                }
            }
            return true;
        }

       public static int getType(TaskStatusModel models,TaskCrane Task) {
            int craneType1 = 0;//空闲，1取货中，2取货完成，3 放货行走
            if(CraneTools.taskIdle(models)) {//货位空闲
                if(Task != null) {//有放货任务
                    craneType1 = 3;
                } else {
                    craneType1 = 1;
                }
            } else {//如果忙
                if(models.IsIn == 1) {
                    craneType1 = 2;//第一个货叉
                } else {
                    craneType1 = 4;//第一个货叉
                }
            }
            return craneType1;
        }

    

        public static TaskModel ConvertTaskModel(TaskCrane task,ushort forkNo=1) {
            if (task == null)
                return null;
            int centerDistance = 0;
           

            TaskModel model = new TaskModel() {
                
            };
          

            //测试货位用
           // model.SMATCode = SemiAutoActionCode.RUNONLY;
            return model;
        }
        public static TaskModel ConvertMoveTaskModel(TaskCrane task) {
            if(task == null) {
                return null;
            }
            return toinPoint(0, 0, 0,0);
        }
        public static TaskModel toinPoint(int x,int y,int X,int Y) {
                TaskCrane lastTask = new TaskCrane();
                if(MathUtil.at(x,y,X,Y)) {
                    return null;
                }
               
                return CraneTools.ConvertTaskModel(lastTask);
          
        }


        public static short CovertTaskStatus(TaskStatus state) {
            return (short)state;
        }

        public static string CheckRobot(RobotStatus robotState) {
            string text = string.Empty;
                bool flag2 = robotState.Cranestatus == CraneStatus.INIT;
                if(flag2) {
                    text = "Error.The robot is initializes,please waiting...";
                }
                bool flag3 = robotState.Cranestatus == CraneStatus.Offline;
                if(flag3) {
                    text = "Error.The robot is in offline state";
                }
                if(robotState.errCodeNo >1) {
                    try {
                         text =  rertText(robotState);
                    } catch(Exception ex) {
                        text = "枚举转换报错：" + ex.Message;
                    }
                }
             
            if(!string.IsNullOrEmpty(robotState.errMsg)) {
                text = robotState.errMsg;
            }
            String[] errors = { "Errcode:INIT.The robot state","ModBus TCP ERR","NetWork Error","索引超出了数组界限" };
            foreach(String error in errors) {
                if(text.Contains(error)) {
                    return "";
                }
            }

            return text;
           
        }

        static String rertText(RobotStatus robotState) {
            var forkErrcode = robotState.ForkStatus[1];
            String format = "Errcode:{0},ErrDetail:{1},ForkErrcode{2},errCodeNo:{3}";
            String text = string.Format(format,new object[]
                             {  robotState.errCode.ToString(),
                                robotState.errDatailCode.ToString(),
                                forkErrcode.ToString(),
                                robotState.errCodeNo
                             });

            return text;
        }

        static public bool taskIdle(TaskStatusModel model) {
            if(model.State == TaskStatus.UNLOADED) {
                return true;
            }

            if(model.State == TaskStatus.INIT) {
                return true;
            }

            if(model.State == TaskStatus.SEMIAUTO_COMPLETE) {
                return true;
            }
            return false;

        }

       public static bool isFinsh(TaskCrane tc) {
            if(tc == null) {
                return true;
            }
            int status = tc.status;
            if(status == 9) {
                return true;
            }
            if(status == 7 ) {
                return true;
            }
           
            return false;
        }
    }
}
