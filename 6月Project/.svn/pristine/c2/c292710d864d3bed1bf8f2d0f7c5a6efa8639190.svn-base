using GK.BACK.DAL;
using GK.Common.dto;
using GK.Common.entity;
using GK.Fmxt.DAL;
using GK.FMXT.DAL.dto;
using GK.FMXT.DAL.Entity;
using GK.Mongo.Dto;
using GK.Mongon.DAL;
using GK.WMS.Entity;
using MongoDB.Bson;
using MongoDB.Driver;
using MongoDB.Driver.Builders;
using Newtonsoft.Json;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Management.Instrumentation;
using System.Text;

namespace GK.FMXT.DAL
{
    public class CodeInfoUtil
    {
        static IMiddleServer middleServer = FmxtDalFactray.getDal<IMiddleServer>();
        public static void SyncCodeInfo()
        {
            List<CoreCodeInfo> list = GetCodeList(middleServer.GetByBatchId());
            if (list.Count == 0)
            {
                return;
            }
            var collection = MongonBaseDAL.database.GetCollection<BsonDocument>("CoreCodeInfo");
            List<BsonDocument> mongonList = new List<BsonDocument>();
            foreach (CoreCodeInfo codeInfo in list)
            {
                if (codeInfo.level == 2)
                {
                    //SaveCodeInfo(mongonList, codeInfo);
                    var listRemoteCode2 = GetCodeInfo(codeInfo.barCode);
                    foreach (var remoteCodeInfo2 in listRemoteCode2)
                    {
                        CoreCodeInfo codeInfo2 = new CoreCodeInfo();
                        codeInfo2.barCode = remoteCodeInfo2.barCode;
                        codeInfo2.parentCode = codeInfo.barCode;
                        codeInfo2.level = 1;
                        codeInfo2.stockDetailId = codeInfo.stockDetailId;
                        codeInfo2.isFull = 1;
                        SaveCodeInfo(mongonList, codeInfo2);
                    }
                }
                else if (codeInfo.level == 3)
                {
                    //SaveCodeInfo(mongonList, codeInfo);
                    var listRemoteCode2 = GetCodeInfo(codeInfo.barCode);
                    foreach (var remoteCodeInfo2 in listRemoteCode2)
                    {
                        CoreCodeInfo codeInfo2 = new CoreCodeInfo();
                        codeInfo2.barCode = remoteCodeInfo2.barCode;
                        codeInfo2.parentCode = codeInfo.barCode;
                        codeInfo2.level = 2;
                        codeInfo2.stockDetailId = codeInfo.stockDetailId;
                        codeInfo2.isFull = 1;
                        SaveCodeInfo(mongonList, codeInfo2);

                        var listRemoteCode1 = GetCodeInfo(codeInfo2.barCode);
                        foreach (var remoteCodeInfo1 in listRemoteCode1)
                        {
                            CoreCodeInfo codeInfo1 = new CoreCodeInfo();
                            codeInfo1.barCode = remoteCodeInfo1.barCode;
                            codeInfo1.parentCode = codeInfo2.barCode;
                            codeInfo1.level = 1;
                            codeInfo1.stockDetailId = codeInfo.stockDetailId;
                            codeInfo2.isFull = 1;
                            SaveCodeInfo(mongonList, codeInfo1);
                        }
                    }
                }
            }
            collection.InsertBatch(mongonList);
        }


        //public static void saveCodeInfo(String into) {
        //    CoreCodeInfo codeInfo = new CoreCodeInfo();
        //    codeInfo.

        //    var collection = MongonBaseDAL.database.GetCollection<BsonDocument>("CoreCodeInfo");

        //    List<BsonDocument> mongonList = new List<BsonDocument>();
        //    BsonDocument document = BsonDocument.Parse(JsonConvert.SerializeObject(mi));
        //    document.Remove("_id");
        //    mongonList.Add(document);
        //    collection.InsertBatch(mongonList);
        //}

        public static List<BsonDocument> SaveCodeInfo(List<BsonDocument> mongonList, CoreCodeInfo codeInfo)
        {
            if (!Exist(codeInfo.barCode))
            {
                BsonDocument document = BsonDocument.Parse(JsonConvert.SerializeObject(codeInfo));
                document.Remove("_id");
                mongonList.Add(document);
            }
            return mongonList;
        }
        public static List<LogCodeDetail> GetCodeInfo(string parentCode)
        {
            return middleServer.GetByBarCode("", parentCode);
        }
        public static bool Exist(string barCode)
        {
            MongoCollection<CoreCodeInfo> collection = MongonBaseDAL.database.GetCollection<CoreCodeInfo>("CoreCodeInfo");
            List<IMongoQuery> queryList = new List<IMongoQuery>();
            queryList.Add(Query.EQ("barCode", barCode));
            var query = Query.And(queryList);
            if (collection.FindOne(query) != null)
            {
                return true;
            }
            else
            {
                return false;
            }
        }


        public static Page<CoreCodeInfo> page(CodeInfoDto param)
        {
            int begin = (param.pageNum - 1) * param.pageSize + 1;
            int limit = param.pageSize;
            MongoCollection<CoreCodeInfo> collection = MongonBaseDAL.database.GetCollection<CoreCodeInfo>("CoreCodeInfo");

            List<IMongoQuery> queryList = getParam(param);
            Page<CoreCodeInfo> page = new Page<CoreCodeInfo>();
            MongoCursor<CoreCodeInfo> result = null;
            if (queryList.Count > 0)
            {
                var query = Query.And(queryList);
                result = collection.Find(query).SetSkip(begin).SetLimit(limit).SetSortOrder(SortBy.Descending("ticks"));
                page.totalSize = collection.Count(query);
            }
            else
            {
                result = collection.FindAll().SetSkip(begin).SetLimit(limit).SetSortOrder(SortBy.Descending("ticks"));
                page.totalSize = collection.Count();
            }

            List<CoreCodeInfo> codeInfoList = new List<CoreCodeInfo>();
            foreach (CoreCodeInfo codeInfo in result)
            {
                codeInfoList.Add(codeInfo);
            }
            page.content = codeInfoList;
            return page;
        }

        static List<IMongoQuery> getParam(CodeInfoDto param)
        {
            List<IMongoQuery> queryList = new List<IMongoQuery>();

            if (!String.IsNullOrEmpty(param.barCode))
            {
                queryList.Add(Query.Matches("barCode", "/" + param.barCode + "/"));
            }
            if (!String.IsNullOrEmpty(param.parentCode))
            {
                queryList.Add(Query.Matches("parentCode", "/" + param.parentCode + "/"));
            }

            return queryList;
        }
        static public List<CoreCodeInfo> GetCodeList(List<CoreStockDetail> list)
        {
            MongoCollection<CoreCodeInfo> collection = MongonBaseDAL.database.GetCollection<CoreCodeInfo>("CoreCodeInfo");
            List<IMongoQuery> queryList = new List<IMongoQuery>();
            List<BsonValue> valueList = new List<BsonValue>();
            foreach (var item in list)
            {
                valueList.Add(BsonValue.Create(item.id));
            }
            queryList.Add(Query.In("stockDetailId", valueList));
            var query = Query.And(queryList);
            return collection.Find(query).ToList();
        }
    }
}
