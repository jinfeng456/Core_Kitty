
using System.Collections.Generic;

using GK.WCS.DAL;
using GK.WCS.Entity;
using GK.WCS.Common;
using GK.WCS.Crane.dto;
using GK.WCS.Carrier;
using GK.WCS.Common.task;
using GK.WCS.Carrier.dto;

namespace GK.WCS.Crane {
    public abstract class CraneSimpleForkTask:CraneAllocateJobHX {


        ITaskCarrierServer carrierDAL = ServerFactray.getServer<ITaskCarrierServer>();
        INoTaskControlServer contralDal = ServerFactray.getServer<INoTaskControlServer>();
        IPhysicalLocationServer dictDal = ServerFactray.getServer<IPhysicalLocationServer>();
        protected CarrierSynchro carrierSynchro = null;
        CarrierConnect carrierCon;
        public CraneSimpleForkTask(int id) : base(id) {
        }
        protected override void onlyOneTime() {
            base.onlyOneTime();
            carrierSynchro = (CarrierSynchro)TaskPool.get<CarrierSynchro>(1);
            carrierCon=(CarrierConnect)TaskPool.get<CarrierConnect1>(1);
        }
        sealed public override TaskCrane analyseTaskModel(GkCraneStatusBase gcs) {
            int dir1 = carrierCon.getCarrierDir(4);
            int dir3 = carrierCon.getCarrierDir(6);
            List<TaskCrane> tcList= craneTaskDAL.getWorkingTask(craneId,dir1,dir3);
            if (tcList == null)
            {
                return null;
            }
            foreach (TaskCrane crane in tcList) {
                if(crane.status!=1 && crane.status != 9 && crane.status != -1)
                LoggerCommon.fileAll(craneId + "数据库有未完成任务" + crane.taskNo);
                return null;
            }   
            relyRemove(tcList);
            carrierRemove(tcList);
            return tcList[0];

        }
      

       

        public  void carrierRemove(List<TaskCrane> allFtList) {

            List<ushort> inList = inPoint();
            List<ushort> outList = outPoint();
            bool cannotOut1 = false;
            bool cannotOut2 = false;
            foreach (ushort o in outList) {
                if (o == 1011 || o==1012)
                {
                    CarrierSignalStatus ssOut1 = carrierSynchro.getSignalStatut(o);
                    if (ssOut1 == null || ssOut1.taskNo != 0 || ssOut1.free != 1)
                    {
                        cannotOut1 = true;
                    }
                }
                else if (o == 1023 || o==1024)
                {
                    CarrierSignalStatus ssOut2 = carrierSynchro.getSignalStatut(o);
                    if (ssOut2 == null || ssOut2.taskNo != 0 || ssOut2.free != 1)
                    {
                        cannotOut2 = true;
                    }
                }
               
            }
       
            List<TaskCrane> removeList = new List<TaskCrane>();
            foreach (TaskCrane ft in allFtList) {
                
                if (ft.taskType == 1)
                {
                    foreach(ushort inp in inList)
                    {
                        if (inp == 1011 || inp == 1012)
                        {
                            CarrierSignalStatus ssIn1 = carrierSynchro.getSignalStatut(inp);
                            if ((ft.fromId==1011 ||ft.fromId==1012) &&(ssIn1 == null || ft.taskNo != ssIn1.taskNo || ssIn1.arrived != 1))
                            {
                                removeList.Add(ft);
                            }
                        }
                        else if (inp == 1023 || inp == 1024)
                        {
                            CarrierSignalStatus ssIn2 = carrierSynchro.getSignalStatut(inp);
                            if ((ft.fromId==1023||ft.fromId==1024) && (ssIn2 == null || ft.taskNo != ssIn2.taskNo || ssIn2.arrived !=1))
                            {
                                removeList.Add(ft);
                            }
                        }
                    }
                }
                else if (ft.taskType == 2)
                {
                    if (cannotOut1)
                    {
                        if ( ft.toId == 1011 || ft.toId == 1012)
                        {
                            removeList.Add(ft);
                        }
                    }
                    else if (cannotOut2)
                    {
                        if ( ft.toId == 1023 || ft.toId == 1024)
                        {
                            removeList.Add(ft);
                        }
                    }
                }
            }

            foreach (TaskCrane ft in removeList) {
                if (allFtList.Contains(ft)) {
                    allFtList.Remove(ft);
                }
            }
          
        }

        public abstract List<ushort> inPoint();
        public abstract int defoutPoint();
        public abstract List<ushort> outPoint();
    }
}