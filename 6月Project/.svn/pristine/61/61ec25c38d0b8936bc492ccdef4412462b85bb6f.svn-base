
using System.Collections.Generic;
using GK.WCS.Entity;
using GK.WCS.Carrier;
using GK.WCS.Common.core.dto;
using GK.WCS.Crane.dto;
using GK.WCS.Carrier.dto;

namespace GK.WCS.Crane {
    public abstract class CraneDoubleForkCarrierJobHX:CraneDoubleForkTask {

        public CraneDoubleForkCarrierJobHX(int id) :base(id) {
        }

        public abstract List<int> outPointLeft();
        public abstract List<int> outPointRight();
        public abstract int defoutPoint();
        public override TaskCrane preExecution() {
            return null;
        }
        
        public  List<TaskCrane> willRemove(List<TaskCrane> allFtList) {
            List<TaskCrane> removeList = new List<TaskCrane>();

            removeIn(allFtList,removeList);
            List<int> outList = new List<int>();
            outList.AddRange(outPointRight());
            outList.AddRange(outPointLeft());
            foreach(int point in outList) {
                int shelfid = (37 - point % 1000 / 10) / 2;
                CarrierSignalStatus s1 = carrierSynchro.getSignalStatus(point);

                if(s1==null) {
                    foreach(TaskCrane ft in allFtList) {
                       
                            if(!removeList.Contains(ft)) {
                                removeList.Add(ft);
                            }
                        
                    }
                }
            }
            return removeList;
        }


        void removeIn(List<TaskCrane> allFtList,List<TaskCrane> removeList) {
            List<int> inTaskList = getCanInTasks();
            foreach(TaskCrane ft in allFtList) {
                if(ft.taskType == 1) {
                    //if(ft.pick.status == 1 && !inTaskList.Contains(ft.pick.taskNo)) {//
                    //    removeList.Add(ft);//删除任务但是不在入库口的入库任务
                    //}
                }
            }
        }
        List<int> getCanInTasks() {
            List<int> inList = inPoint();

            List<int> inTaskList = new List<int>();
            foreach(int point in inList) {
                CarrierSignalStatus s1 = carrierSynchro.getSignalStatus(point);
                if(s1 == null) {
                    continue;
                }
                if( s1.taskNo > 0) {
                    inTaskList.Add(s1.taskNo);
                }

            }
            return inTaskList;
        }
  
        /// <summary>
        /// 
        /// </summary>
        /// <param name="forkNo">货叉号</param>
        /// <param name="tc">当前任务</param>
        /// <param name="otherPutTc">另一个货叉任务</param>
        /// <returns></returns>
        public override int getPutPoint(int forkNo,TaskCrane tc,TaskCrane otherPutTc) {
            List<int> outList =null;

            CarrierSignalStatus ssOut1 = carrierSynchro.getSignalStatus(outList[0]);
            CarrierSignalStatus ssOut2 = carrierSynchro.getSignalStatus(outList[1]);
          
            if(forkNo == 2) {
                if(ssOut1.taskNo==0 && otherPutTc == null ) {//另一个货叉没有放货
                    return outList[0];
                } 
                if(ssOut2.taskNo == 0) {
                    return outList[1];
                }  
            } 
               
            return 0;
        }

     

        public override ushort getPickForkNo(TaskCrane tc,List<TaskOrder> list,List<int> bastForkNo) {
            bool fork1CanPick = false;
            bool fork2CanPick = false;
            
            foreach(int forkNo in bastForkNo) {
                if(forkNo == 1) {
                    fork1CanPick = true;
                }
                if(forkNo == 2) {
                    fork2CanPick = true;
                }
            }
            if(tc.taskType == 1) {
                ushort fork =  inStockFork(fork1CanPick,fork2CanPick,tc);

                foreach(int forkNo in bastForkNo) {
                    if(forkNo == fork) {
                        return fork;
                    }
                   
                }

            }  else {
                return (ushort)bastForkNo[0];
            }

            return 0;
        }


      


        ushort inStockFork(bool fork1CanPick,bool fork2CanPick,TaskCrane tc) {
            List<int> inList = inPoint();
            foreach(int p in inList) {
                CarrierSignalStatus ss1 = carrierSynchro.getSignalStatus(p);
              
                if(tc.taskNo != ss1.taskNo) {
                    continue;
                }
                if(p / 1000 == 1) {//1号plc
                    if(p % 10 == 2) {//远离垛机
                        if(fork1CanPick) {
                            return 1;
                        } else {
                            return 0;
                        }
                    } else {//1号plc 货架近光电
                        if(fork2CanPick) {
                            return 2;
                        } else {
                            return 1;
                        }
                    }
                } else {//2号plc
                    if(p % 10 == 2) {//远离垛机
                        if(fork2CanPick) {
                            return 2;
                        } else {
                            return 0;
                        }
                    } else {//1号plc 货架近光电
                        if(fork1CanPick) {
                            return 1;
                        } else {
                            return 2;
                        }
                    }

                }
            }
            return 0;
        }
      
    }
}
