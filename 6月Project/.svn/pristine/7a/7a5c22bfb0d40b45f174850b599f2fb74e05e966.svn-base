using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Security.Principal;
using System.Web;
using System.Web.Http;
using System.Web.Security;
using Hx.Wms.Domain;
using HY.WCS.DAL;
using HY.WCS.DAL.wcs;
using Web.Authorize;

namespace WebApi {
    [FormAuthenticationFilter]
    [RoutePrefix("api/menu")]
    public class MenuController:BaseApiController {
        [HttpGet, Route("getMenu")]
        public BaseResult getMenu() {
            UserRoleDAL UserRoledal = new UserRoleDAL();
            GenericPrincipal principal = (GenericPrincipal)HttpContext.Current.User;
            FormsIdentity identity = (FormsIdentity)principal.Identity;
            FormsAuthenticationTicket ticket = identity.Ticket;
            string userid = ticket.UserData;
            string  Roleid = UserRoledal.getSelectionRolesId(userid).id.ToString();
            DataTable dt = UserRoledal.getUsersRolesList_Qiantai(Roleid, "0");
            List<Menu> list = new List<Menu>();
            foreach(DataRow dr in dt.Rows)
             {
                string name = dr["Name"].ToString();
                string menuId = dr["MenuId"].ToString();
                Menu munu = new Menu(name, "");
                DataTable data= UserRoledal.getUsersRolesList_Qiantai(Roleid, menuId);
                foreach (DataRow datar in data.Rows)
                {
                    munu.add(new Menu(datar["name"].ToString(), datar["url"].ToString()));
                }
            list.Add(munu);
            }
            return new BaseResult(list);
        }
    }

    public class Menu{

        public Menu(String name, String path)
        {
            this.name = name;
            this.path = path;
        }

        public void add(Menu m) {
            if(children == null) {
                children = new List<Menu>();
            }
            children.Add(m);
        }
       public String name;
        public String path;
        public List<Menu> children;
    }
}
