using System;

using System.Threading.Tasks;
using GK.Common.entity;
using GK.Mongon.DAL;

using Quartz;
using Quartz.Impl;

namespace Web.job {
  
    public class TimeJob:IJob {

        private static Object lockObj = new Object()
            ;
        private static int working = 0;

        Task IJob.Execute(IJobExecutionContext context) {
            
            lock(lockObj) {
                if(working == 0) {
                    working = 1;
                } else {
                    return Task.CompletedTask;
                }
            }
            try {
                upload();
                 wmsBack();
            } catch(Exception e) {
                addLogger("upload Exception",e.Message);
            } finally {
                working = 0;
            }
            
            return Task.CompletedTask;
        }

        void wmsBack() {
            /*
            String info = new CommonProcedure().zBack();
            
            if(!String.IsNullOrWhiteSpace(info)) {
                if(info != "ok0") {
                    addLogger("wms back",info);
                }
                
            }*/
            
         
        }


       void upload() {
           /*
            foreach(StockTask task in list) {
                if(task.Status != 3) {
                    continue;
                }
                if(task.upload == 1) {
                    continue;
                }
                if(task.TaskType == 1) {
                    String res = WsMes.rkFinsh(task.boxCode,task.DesID + "");
                    if(!res.StartsWith("入库成功")) {
                        addLogger(task.id + "",task.boxCode + "to" + task.DesID + "send mes error");

                        Thread.Sleep(20000);
                        continue;
                    } else {
                        dal.finishUploadMes(task.id);
                    }
                } else if(task.TaskType == 2) {
                    int outType = (int)(task.outType);
                     if(outType == 2) {
                        String res = WsMes.chuhuoFinsh("订单号","箱号","gg",task.boxCode);
                        if(!res.StartsWith("出库成功")) {
                            addLogger(task.id + "",task.boxCode + "to" + task.DesID + "send mes error");
                            continue;
                        } else {
                            dal.finishUploadMes(task.id);
                        }
                    } else {
                        String res = WsMes.lingliaoFinsh("光纤","","user1",task.boxCode);
                        if(!res.StartsWith("领料成功")) {
                            addLogger(task.id + "",task.boxCode + "to" + task.DesID + "send mes error");
                            Thread.Sleep(20000);
                            continue;
                        } else {
                            dal.finishUploadMes(task.id);
                        }
                    } 

                } else if(task.TaskType == 3) {
                    dal.finishUploadMes(task.id);
                }
            }
            */

        }

        void addLogger(String param, String info) {

            HttpLog log = new HttpLog();
            log.urlName = "wmsjob";
            log.param = param;
            log.result = info;
            log.ip = "";
            HttpClientLogUtil.save(log);
        }
    }

  

}