using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using CMFrameWork.Common;
using CMNetLib.Robots.CarrierChain;
using GK.WCS.Client;
using GK.WCS.Client.Control;
using GK.WCS.Client.Station;
using GK.WCS.Common.core.dto;
using GK.WCS.Client.Control;
using HY.WCS.Common.Entity;
using GK.WCS.Carrier;

namespace GK.WCS.Client.Frm {
    public  class CarrierBase:Form {
        public List<System.Windows.Forms.Button> buttonAtt = new List<System.Windows.Forms.Button>();

        public List<Belt> lines = new List<Belt>();

        //public Dictionary<String,Belt> beltDict = new Dictionary<String,Belt>();

        public string buttomName = String.Empty;
        public void updateCarrierChain(Dictionary<int,HyMachineState> CarrierChainState) {

            if(CarrierChainState == null || CarrierChainState.Count == 0) {
                return;
            }
            for(var i = 0;i < lines.Count;i++) {
                if(lines[i] == null) {
                    continue;
                }
                var CarrierChainID = i + 1;
                if(CarrierChainID == 0) {
                    continue;
                }
                if(!CarrierChainState.ContainsKey(CarrierChainID)) {
                    continue;
                }

                HyMachineState machineState = CarrierChainState[CarrierChainID];
                lines[i].SetArrowColor(CU.change(machineState.Status));
                lines[i].SetLineColor(CU.change(machineState.ErrCode));
                
            }


        }

        public void uploadSignalStates(Dictionary<int,HySignalState> dict) {


            foreach(Button b in buttonAtt) {
                if(null == b) {
                    continue;
                }
                var name = b.Name;
                int key = name.Substring(2).ToInt32(0);
                // key = getSid(key);
                if(!dict.ContainsKey(key)) {
                    continue;
                }
                HySignalState ss = dict[key];
                if(ss.TaskNo > 0) {
                    addColor(b,buttomName == name,true);
                } else {
                    addColor(b,buttomName == name,false);
                }
                int lineid = key / 10;
                int pos = key % 10;

                for(var i = 0;i < lines.Count;i++) {
                    Belt line = lines[i];
                    if(line == null) {
                        continue;
                    }
                    if(line.Name == "lin" + lineid) {
                      
                        if(pos == 1) {
                            line.setSign1(ss.OnOff);
                        } else if(pos == 2) {
                            line.setSign2(ss.OnOff);
                        }
                        break;
                    }

                }
                
            }

        }


        /*有数据 选中 黄色
         * 无数据 选中 白色
         * 有数据 没有选中 绿色
         * 无数据 没有选中 黑色
         * 
         * */


        public Dictionary<int,HySignalState> dict = new Dictionary<int,HySignalState>();
        public TextBox taskNoInupt;

        public void addColor(Button b,Boolean select,Boolean hasData) {
            try {
                var name = b.Name;
                if(select) { //select
                    if(hasData) {
                        this.Invoke(new Action(() => {
                            b.BackColor = System.Drawing.Color.Yellow;
                        }));
                    } else {
                        this.Invoke(new Action(() => {
                            b.BackColor = System.Drawing.Color.White;
                        }));
                    }
                } else {

                    if(hasData) {
                        this.Invoke(new Action(() => {
                            b.BackColor = System.Drawing.Color.Green;
                        }));
                    } else {
                        this.Invoke(new Action(() => {
                            b.BackColor = System.Drawing.Color.Black;
                        }));
                    }
                }
                if(buttomName != name) {
                    return;
                }

                int key = name.Substring(2).ToInt32(0);
                HySignalState ss = dict[key];
                if(ss != null && ss.TaskNo > 0) {
                    String value = ss.TaskNo.ToString();
                    if(taskNoInupt.Text != value) {

                        this.Invoke(new Action(() => {
                            taskNoInupt.Text = value;
                        }));
                    }

                } else {
                    if(taskNoInupt.Text != "") {
                        this.Invoke(new Action(() => {
                            taskNoInupt.Text = "";
                        }));
                    }

                }
            } catch { }


        }
        public  void bClick(object sender,EventArgs e) {
            System.Windows.Forms.Button b = (System.Windows.Forms.Button)sender;
            int sid = b.Text.ToString().ToInt32();
            setText(sid/10);
            foreach(System.Windows.Forms.Button bt in buttonAtt) {
                if(bt == null) {
                    continue;
                }
                if(bt.Name == buttomName) {
                    int key = bt.Name.Substring(2).ToInt32(0);

                    key = getSid(key);
                    if(dict.ContainsKey(key)) {

                        HySignalState ss = dict[key];
                        if(ss.TaskNo > 0) {
                            addColor(bt,false,true);
                        } else {
                            addColor(bt,false,false);
                        }
                    } else {
                        addColor(bt,false,false);
                    }


                    break;
                }
            }
            if(buttomName == b.Name) {
                buttomName = String.Empty;
            } else {

                int key = b.Name.Substring(2).ToInt32(0);
                key = getSid(key);
                if(dict.ContainsKey(key)) {

                    HySignalState ss = dict[key];
                    if(ss.TaskNo > 0) {
                        addColor(b,true,true);
                        taskNoInupt.Text = ss.TaskNo + "";
                    } else {
                        addColor(b,true,false);
                        taskNoInupt.Text = "";
                    }
                } else {
                    addColor(b,true,false);
                    taskNoInupt.Text = "";
                }

                buttomName = b.Name;
            }
        }
        public virtual  void setText(int path) { }

        int getSid(int lineId) {
            int key = 0;
            if(lineId == 15) {
                key = 151;
            } else {
                key = lineId * 10 + 2;
            }
            return key;
        }
        public void Send(int Taskno,ushort from,ushort end,int posin) {
            Path path = null;
            foreach(Path p in Constant.pathList) {
                if(p.from == from && p.end == end) {
                    path = p;
                    break;
                }
            }
            if(path == null) {
                MessageBox.Show("路径不存在");
                return;
            }
            String info = HttpCarrierUtil.sendMiddle(Taskno,path.path,posin);
            MessageBox.Show(info);

        }

        private void InitializeComponent() {
            this.SuspendLayout();
            // 
            // CarrierBase
            // 
            this.ClientSize = new System.Drawing.Size(284, 261);
            this.Name = "CarrierBase";
           
            this.ResumeLayout(false);

        }

       
    }
}
