<template>
  <div class="page-container">
	<!--新增编辑界面-->
	<el-dialog :title="operation?'物料出库新增':'物料出库编辑'" width="80%"   :visible.sync="dialogVisible" custom-class="myHeadClass" :close-on-click-modal="false" @opened="getDetials"  :before-close="handleClose">
		<el-form :model="subDataForm" label-width="200px" :rules="dataFormRules" ref="dataForm" size="mini"
			label-position="right">
			<el-row>
				<el-col :span="8">
					<el-form-item label="ID" prop="id" v-if="false">
						<el-input v-model="subDataForm.id" disabled="true" auto-complete="off"></el-input>
					</el-form-item>
				
					<el-form-item :label="$t('field.receipt.srcSoNo')" prop="srcSoNo">
						<el-input v-model="subDataForm.srcSoNo" auto-complete="off"></el-input>
					</el-form-item>
				</el-col>
				<el-col :span="8">
					<el-form-item :label="$t('field.receipt.outType')" prop="outType" >
						<el-select v-model="subDataForm.outType"  style="width: 100%;">
							<el-option v-for="item in dicts.outTypeItem" :key="item.value"
								:label="item.label" :value="item.value">
							</el-option>
						</el-select>
					</el-form-item>
				</el-col>
				<el-col :span="8">
					<el-form-item :label="$t('field.receipt.stn')"  prop="stn" >
						<el-select v-model="subDataForm.stn"  :placeholder="$t('action.select')" style="width: 100%;">
							<el-option v-for="item in dicts.stnOut" :key="item.value"  :value="item.value"
								:label="item.label">
							</el-option>
						</el-select>
					</el-form-item>
				
				</el-col>
			</el-row>
			<el-row>
				<el-col :span="8">
					<el-form-item :label="$t('field.receipt.receiptNo')" prop="receiptNo">
						<el-input v-model="subDataForm.receiptNo" auto-complete="off"></el-input>
					</el-form-item>
				</el-col>
			
				<el-col :span="8">
					<el-form-item :label="$t('field.receipt.priority')" prop="priority">
						<el-select v-model="subDataForm.priority"  :placeholder="$t('action.select')" style="width: 100%;">
							<el-option v-for="item in dicts.priority" :key="item.value"
								:label="item.label" :value="item.value">
							</el-option>
						</el-select>
					</el-form-item>
				</el-col>
			</el-row>
		</el-form>
		<div slot="footer" class="dialog-footer">
			<el-button size="mini" @click.native="handleHiddenOut">{{$t('action.cancel')}}</el-button>
			<el-button size="mini" type="primary" @click.native="submitForm" :loading="editLoading">{{$t('action.submit')}}</el-button>
			<el-button size="mini"  @click.native="handleAddDetailEdit"  >增加明细 </el-button>
		</div>

		<div v-show="!operation">
			<div class="app-container">
				<el-table v-loading="listLoading" :data="list" border fit highlight-current-row style="width: 100%" size="mini">
				<el-table-column width="120px" align="center" :label="$t('field.stn')"   fixed="right" prop="stn" key="stn"  header-align="center" :formatter="statusFilter">
				</el-table-column>
				<el-table-column class-name="status-col"  :label="$t('field.itemName')"    min-width="110" prop="itemId"  align="center" fixed="right"  header-align="center"  :formatter="itemFilter">
					
				</el-table-column>
				<el-table-column width="200px"   :label="$t('field.planCount')"    align="center"  fixed="right"  header-align="center" >
				
					<template slot-scope="{row}"  >
						<template v-if="row.edit">
							<el-input v-model="row.planCount" class="edit-input" size="mini"  />
						</template>
						<span  style="cursor: pointer;" v-else  >{{ row.planCount }}</span>
					</template>
				
				</el-table-column>
			
				<el-table-column align="center" :label="$t('action.edit')" width="120" fixed="right" >
						<template slot-scope="{row}">
						<el-button v-if="row.edit" type="success" size="mini"  @click="confirmEdit(row)" icon="el-icon-circle-check-outline" > {{$t('action.comfirm')}} 
						</el-button>
						<el-button v-else type="primary" size="mini" icon="el-icon-edit" @click="row.edit=!row.edit" >   {{$t('action.edit')}} 
						</el-button>
						</template>
					</el-table-column>


				<el-table-column :label="$t('action.operation')" width="105" fixed="right"  header-align="center" align="center">	
					<template slot-scope="scope">
					<kt-button icon="fa fa-trash" :label="$t('action.delete')" perms="core:receiptout:delete" :size="size" type="danger" @click="handleDelete(scope.$index, scope.row)" />
					</template>
				</el-table-column>
				
				</el-table>
			</div>
		</div>
	
	</el-dialog>
	  <item-select   :itemDialogVisible="itemDialogVisible" @handleSelect="handleSelect"   @itemHidden="itemHidden"></item-select>
  
  </div>
</template>

<script>
import KtTableList from "@/views/Core/KtTableList"
import KtButton from "@/views/Core/KtButton"
import { format } from "@/utils/datetime"
import ItemSelect from "@/views/Material/ItemSelect"
export default {
	name: 'EditReceiptOut',
	components:{
		KtTableList,
		KtButton,
		ItemSelect
	},
	filters: {
	
  },
	props:{
		subDataForm:{
			type: Object
		},
	    dialogVisible:{
			type: Boolean
		},
		operation:{
			type: Boolean
		}
	},
	
	data() {
		return {
			size: 'mini',
			   listLoading: false,
			list:[],
		
			pageResult: {},
		
			editLoading: false,
			pageRequest: { pageNum: 1, pageSize: 1000 },
			itemDialogVisible:false,
		
			dicts:this.$store.state.dict.dicts
		}
	},
	computed: {
		dataFormRules() {
			
			}		
	},
	methods: {
			
				confirmEdit(row) {
						//row.edit = false
						this.$api.receipt.updateDetials({id:row.id,planCount:row.planCount}).then((res) => {
						this.getDetials();
					})
				},

			statusFilter(status) {

			let key="stnOut"
			let dict = this.$store.state.dict.dicts[key];
			if(dict==undefined){
					return status
			}
			for(let i=0;i<dict.length;i++){
				if(dict[i].value==status.stn){
					return dict[i].label;
				}
			}

          	return status
		},
		itemFilter:  function (row, column, cellValue, index){
		
			let propt=column.property;
		    let val=row[column.property];
			let dict = this.$store.state.dict.item
			if(dict==undefined){
					return row[column.property]
			}
			for(let i=0;i<dict.length;i++){
				if(dict[i].id==val){
					return dict[i].name;
				}
			}

          	return row[column.property]
      	},

		
		handleDelete:function(index,row){
			this.$api.receipt.deleteDetial(row.id).then((res) => {
			
				this.getDetials();
			})
	

		},
		handleSelect:function(data){
		 	this.$api.receipt.saveDetials({id:this.subDataForm.id,items:data}).then((res) => {
				if(res.code == 200) {
								this.itemHidden();
								this.getDetials();
							} else {
								this.$message({message: this.$t('action.operateFail') + res.msg, type: 'error'})
								this.itemHidden();
								this.getDetials();
							}
			})
	
		},
		handleClose:function(done){
		  this.$emit('receiptHidden', {})
 			done();
		},
		itemHidden:function(){
			this.itemDialogVisible=false;
		},
		// 获取分页数据
		 getDetials :function() {
			if(this.subDataForm==undefined||this.subDataForm.id==undefined||this.subDataForm.id==0){
				return;
			}
			this.listLoading = true
			this.$api.receipt.getDetials(this.subDataForm).then((res) => {
				

 			const items = res.data
			this.list = items.map(v => {
				this.$set(v, 'edit', false) 
				return v
			})
				

			    this.listLoading = false
			})
		},
		
		
		
		
		handleAddDetailEdit: function () {
			this.itemDialogVisible = true
		},
		handleHiddenOut: function (params) {
			this.$emit('receiptHidden', {})
		},
		// 编辑
		submitForm: function () {
			this.$refs.dataForm.validate((valid) => {
				if (valid) {
					this.$confirm(this.$t('action.isConfirm'), this.$t('action.tips'), {}).then(() => {
							this.editLoading = true
						let params = Object.assign({}, this.subDataForm)
						
						this.$api.receipt.saveReceiptOut(params).then((res) => {
							this.editLoading = false
							if(res.code == 200) {
								this.$message({ message: this.$t('action.operateSucess'), type: 'success' })
								this.handleHiddenOut();
								this.$refs['dataForm'].resetFields()
							} else {
								this.$message({message: this.$t('action.operateFail') + res.msg, type: 'error'})
							}
						
						})
			
					})
				}
			})
		}
		
		
		
	},	
	mounted() {
	
	

	}
}
</script>

<style scoped>
  .myHeadClass .el-dialog__header{
    background-color: #ff00ff !important;;
  }
  </style>