<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>大屏</title>
    <style>
    *{margin:0;padding:0;}
    body{text-align:center;background-color:#000;}
    </style>
</head>
<script src='base.js' lang="utf-8"></script>
<body>
    <canvas id="canvas" width="700" height="500" style="background:#000;"></canvas>
  
    
</body>

<script src='Fullscreen.js' lang="utf-8"></script>
<script src='component.js' lang="utf-8"></script>
<script src='ajaxWcs.js' lang="utf-8"></script>
<script src='myCarrierRun.js' lang="utf-8"></script>
</html>

<script>
   
    var cranePic = new Image();  
    cranePic.src = "png/crane.png";  
      var backPic = new Image();  
    backPic.src = "png/back.png";  
      var productPic = new Image();  
    productPic.src = "png/product.png";  
    
      var carrierBackPic = new Image();  
    carrierBackPic.src = "png/carrierBack.png";  
    
    
    craneList=[];  
    carrierList=[];  
    
    storestock = []
    globalX=0;
    globalY=-50; 
    craneBegin=150;
    craneLength=1200.0
   
   var plcPath={};
   plcPath['41']={reverse:42,foreward:44};
   
      function myDraw(context){
      	
      	 context.drawImage(backPic,0,0,canvas.width, canvas.height)
      	 for(var i=0;i<carrierList.length;i++){
				     	 var carrier=		carrierList[i]
		     			 carrier.draw();
		     }
		     for(var i=0;i<craneList.length;i++){
				     	 var crane1=		craneList[i]
				     	 var xmm=crane1.getAnchor().x;
				     	 var goal=crane1.xGoal;
				     	 
				     	 
				     	 
				     	 if(goal>xmm){//目标在右边
				     	 	  crane1.xa=Math.abs(crane1.xa)
					     	 	if(crane1.xv<0){//向左跑
					     	 		crane1.xv+=crane1.xa/10;
					     	 	}
				     	 	
				     	 	}else if(goal<xmm){//目标在左边
				     	 		 crane1.xa=-Math.abs(crane1.xa)
					     	 	if(crane1.xv>0){//向右跑
					     	 		crane1.xv+=crane1.xa/10;
					     	 	}
				     	 	}
				     	 
				     	 var x=	crane1.xv/60.0
				     	 if(Math.abs(goal-xmm)<2){
				     	 	   crane1.setAnchor({x:crane1.xGoal,y:crane1.y})
				     	 	}else{
				     	 		 crane1.move(x,0)
				     	 	}
				     	 
			   			
		     			 crane1.draw();
		     }
		     
		    var arr =  carrierTaskRun.getAllAnthor();
		     			for(var i=0;i<arr.length;i++){
		     				 var p=new Product(context,globalX+68*i,220+globalY);
		     				 p.setAnchor(arr[i])
		     				 p.draw();
		     			}
		     	
         product1.setAnchor(crane1.getAnchor());
		     product1.draw();
		    
      } 
  
        window.onload = function(){
        	
        	for(var i=0;i<82;i++){
        		storestock.push(new Product(context,1000+globalX,220+globalY))
        		}
        	
        	
            var canvas = document.getElementById('canvas');
            var context = canvas.getContext('2d');
            canvas.height= window.screen.height 
            canvas.width= window.screen.width 
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.fillStyle="#0ff";
            context.fillRect(0,0,canvas.width,canvas.height);
            context.translate(0.5,0.5);
            for(var i=1;i<12;i++){
            	  carrierList.push(new CarrierChain(i,context,1150+globalX,150+globalY+i*68,100,0))
            	  carrierList.push(new CarrierChain(i+80,context,1213+globalX,126+globalY+i*68,68,90))
            	  carrierList.push(new Yzj(i+100,context,1201+globalX,150+globalY+i*68,12,12));
            }
            for(var i=1;i<12;i++){
            	  carrierList.push(new CarrierChain(i+20,context,160+globalX,150+globalY+i*68,100))
            	  carrierList.push(new CarrierChain(i+40,context,97+globalX,126+globalY+i*68,68,90))
            	  carrierList.push(new Yzj(i+60,context,103+globalX,150+globalY+i*68,12,12));
            }
			      for(var i=0;i<11;i++){
			       	   craneList.push(new Crane(context,(craneBegin+craneLength)/2,220+globalY+i*68))
			      }
					  product1=new Product(context,1000+globalX,220+globalY);
            //动画循环
			        (function drawFrame(t){
			            window.requestAnimationFrame(drawFrame);
			            context.clearRect(0, 0, canvas.width, canvas.height);
			            context.fillStyle="#0ff";
			            context.fillRect(0,0,canvas.width,canvas.height);
			            myDraw(context);
			          
			             
			        }()); 
			        
			        
			        myReflash("/Daping",function(val){
			        	var signalStates= val.data.SignalStates;
			        	carrierTaskRun.perClear();
			        	 for(let key  in signalStates){
			        	 	var ss=signalStates[key];
				        	 	if(ss.taskNo>0){
				        	 		if(ss.carrierStatus==4){//前进
				        	 			  var nextId= plcPath[key].foreward
				        	 			  carrierTaskRun.updateTask(ss.taskNo,key,nextId)
				        	 		}else if(signalStates[key].carrierStatus==5){//后退
				        	 				var nextId= plcPath[key].reverse
				        	 				carrierTaskRun.updateTask(ss.taskNo,key,nextId)
				        	 		}else{
				        	 			  carrierTaskRun.updateTask(ss.taskNo,key,0)
				        	 		}
				        	 		
				        	 	}
			        	 	
			        	 	}
			        	 	
			        	 carrierTaskRun.myClear();
			        	//alert(val)
			        },function(val){
				        	for(var i=0;i<11;i++){
				        		crane1=craneList[i]
				        			var goalmm=val[i]*craneLength+craneBegin;//目标位置
				        			crane1.xGoal=goalmm;
				        			var crane1 = craneList[i]
						        	var xmm=crane1.getAnchor().x;//当前位置
						          var s=goalmm-xmm
						          var a=(s-crane1.xv)*2
						        	crane1.xa=a
						        	crane1.xv+=crane1.xa/60.0;//当前速度
			        		}
			        })
            
   }
    </script>